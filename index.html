<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ä¹ä¹ã®81ã¾ã™è¨ˆç®—ï¼ˆ9Ã—9ï¼‰</title>

<style>
:root{
  --bg:#f7f8ff;
  --ink:#1f2937;
  --line:#e5e7eb;
  --accent:#4f46e5;
  --shadow:0 10px 24px rgba(0,0,0,.08);
  --mark: rgba(239,68,68,0.78);

  --cellW:56px;
  --cellH:46px;

  /* æ­£å††ã‚µã‚¤ã‚º */
  --circleOuter:30px;
  --circleInner:18px;
  --circleSingle:26px;
}
*{ box-sizing:border-box; }

body{
  margin:0;
  font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif;
  background:var(--bg);
  color:var(--ink);
}
.wrap{ max-width:1200px; margin:16px auto; padding:0 12px 40px; }

.layout{
  display:grid;
  grid-template-columns: 1fr 380px;
  gap:12px;
  align-items:start;
}
@media(max-width:980px){
  .layout{ grid-template-columns:1fr; }
}

.panel{
  background:#fff;
  border:1px solid var(--line);
  border-radius:18px;
  padding:14px;
  box-shadow:0 6px 12px rgba(0,0,0,.06);
}
.card{
  background:#fff;
  border:1px solid var(--line);
  border-radius:24px;
  padding:14px;
  box-shadow:var(--shadow);
}

/* ===== å·¦ä¸Šï¼šã“ãŸãˆã‚’è¦‹ã‚‹ãƒœã‚¿ãƒ³è¡Œ ===== */
.leftTopRow{
  display:flex;
  align-items:center;
  justify-content:flex-start;
  gap:10px;
  margin-bottom:10px;
}
.leftTopRow .leftHint{
  font-weight:900;
  color:#6b7280;
  font-size:13px;
}

/* å·¦ä¸Šãƒœã‚¿ãƒ³ï¼ˆå°ã•ã‚ï¼‰ */
.peekBtn{
  width:auto;
  padding:8px 10px;
  border-radius:12px;

  /* â˜…ãƒ•ãƒã‚’å°‘ã—ç›®ç«‹ãŸã›ã‚‹ */
  border:2px solid rgba(79,70,229,.55);
  box-shadow: 0 0 0 2px rgba(79,70,229,.10);

  background:#fff;
  font-weight:1000;
  cursor:pointer;
  line-height:1;
  user-select:none;
  -webkit-user-select:none;
  touch-action:manipulation;
}
.peekBtn:hover{
  border-color: rgba(79,70,229,.75);
  box-shadow: 0 0 0 3px rgba(79,70,229,.12);
}
.peekBtn:active{ transform: translateY(1px); }
.peekBtn span{ display:inline-block; font-size:13px; }

/* ===== å³ã‚«ãƒ©ãƒ ï¼š7è¡Œ ===== */
.rightStack{
  display:flex;
  flex-direction:column;
  gap:10px;
}
.row{
  display:flex;
  align-items:center;
  width:100%;
}
.rowTitle{ align-items:flex-start; }

.titleText{
  margin:0;
  font-size:20px;
  font-weight:1000;
  line-height:1.25;
}

/* ===== ãƒ™ã‚¹ãƒˆï¼ˆ3ã¤å¸¸æ™‚è¡¨ç¤ºï¼‰ ===== */
.bestGroup{
  display:flex;
  flex-direction:column;
  gap:8px;
  width:100%;
}
.bestBox{
  display:flex;
  align-items:center;
  gap:10px;
  padding:8px 10px;
  border-radius:14px;
  border:1px dashed rgba(79,70,229,.55);
  background:#fbfbff;
  font-weight:1000;
  width:100%;
}
.bestLeft{
  display:flex;
  align-items:baseline;
  gap:8px;
  white-space:nowrap;
  min-width:0;
}
.bestLabel{ font-size:13px; opacity:.85; }
.bestValue{ font-size:20px; letter-spacing:.4px; }

/* â˜… æ¶ˆã™ãƒœã‚¿ãƒ³ï¼šãƒˆãƒ­ãƒ•ã‚£ãƒ¼å·¦ãƒ»å°ã•ãªæ­£æ–¹å½¢ */
.bestClearBtn{
  width:28px;
  height:28px;
  padding:0;
  border-radius:8px;
  border:1px solid var(--line);
  background:#fff;
  font-size:14px;
  font-weight:900;
  cursor:pointer;
  display:grid;
  place-items:center;
  flex:0 0 auto;
}
.bestClearBtn:hover{ background:#fee2e2; }
.bestClearBtn:active{ transform: translateY(1px); }

/* ===== ãƒœã‚¿ãƒ³ ===== */
button{
  padding:10px 12px;
  border-radius:12px;
  border:1px solid var(--line);
  background:#fff;
  font-weight:900;
  cursor:pointer;
  width:100%;
}
button.primary{
  background:var(--accent);
  border-color:transparent;
  color:#fff;
}
button:active{ transform: translateY(1px); }

/* â˜…ä½œæˆãƒœã‚¿ãƒ³ï¼š1è¡Œãƒ»ä¸‰åˆ†ã®ä¸€ */
.makeBtns{
  display:flex;
  gap:8px;
  width:100%;
}
.makeBtns button{
  flex:1;
  width:auto;
  padding:8px 6px;
  font-size:14px;
  white-space:nowrap;

  /* â˜…ãƒ•ãƒã‚’å°‘ã—ç›®ç«‹ãŸã›ã‚‹ï¼ˆã“ãŸãˆã‚’è¦‹ã‚‹ã¨åŒç³»çµ±ï¼‰ */
  border:2px solid rgba(79,70,229,.55);
  box-shadow: 0 0 0 2px rgba(79,70,229,.10);
}
.makeBtns button:hover{
  border-color: rgba(79,70,229,.75);
  box-shadow: 0 0 0 3px rgba(79,70,229,.12);
}

/* ===== ã‚¿ã‚¤ãƒ è¡¨ç¤º ===== */
.timer{
  display:flex;
  align-items:baseline;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid var(--line);
  background:#f8fafc;
  font-weight:1000;
  width:100%;
}
.timer .left{
  display:flex;
  align-items:baseline;
  gap:8px;
}
.timer .label{ font-size:13px; opacity:.85; white-space:nowrap; }
.timer .value{ font-size:22px; letter-spacing:.2px; }
.timer.running{
  border-color: rgba(79,70,229,.45);
  box-shadow: 0 0 0 3px rgba(79,70,229,.12);
}
.hint{
  color:#6b7280;
  font-weight:800;
  font-size:12px;
  line-height:1.2;
  text-align:right;
}
.timerOff{ display:none; }

/* ã‚¿ã‚¤ãƒ ON/OFF */
.switch{
  display:flex;
  align-items:center;
  justify-content:flex-start;
  gap:8px;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid var(--line);
  background:#fff;
  font-weight:900;
  cursor:pointer;
  user-select:none;
  -webkit-user-select:none;
  width:100%;
}
.switch input{ accent-color: var(--accent); }

.note{
  color:#6b7280;
  font-weight:900;
  font-size:13px;
  line-height:1.55;
}

/* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */
.errBar{
  padding:10px 12px;
  border-radius:12px;
  border:1px solid #fecaca;
  background:#fff1f2;
  color:#991b1b;
  font-weight:900;
  display:none;
}

/* ===== å·¦ï¼š81ã¾ã™ ===== */
.masuWrap{
  overflow:auto;
  border:1px solid var(--line);
  border-radius:16px;
  background:#fff;
}

/* è¡¨ï¼ˆå³ã®éš™é–“ãŒå‡ºãªã„ï¼‰ */
table{
  border-collapse:separate;
  border-spacing:0;
  width:max-content;
  min-width:100%;
}
th, td{
  border-right:1px solid var(--line);
  border-bottom:1px solid var(--line);
  padding:0;
  width:var(--cellW);
  height:var(--cellH);
}
tr:first-child th{ border-top:1px solid var(--line); }
th:first-child, td:first-child{ border-left:1px solid var(--line); }
th:last-child, td:last-child{ border-right:none; }

th{
  background:#f8fafc;
  font-weight:1000;
  text-align:center;
  position:sticky;
  z-index:2;
}
th.top{ top:0; }
th.left{ left:0; z-index:3; }
th.corner{
  top:0; left:0;
  z-index:4;
  background:#eef2ff;
}

/* ãƒã‚¹ */
.cell{
  position:relative;
  width:100%;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
}
.cell input{
  width:100%;
  height:100%;
  border:0;
  outline:none;
  text-align:center;
  font-size:16px;
  font-weight:1000;
  background:transparent;
  padding:0;
  line-height:var(--cellH);
  display:block;
}

/* ã¾ã¡ãŒã„è‰² */
.cell.bad{ background:#fff7ed; }
.cell.bad input{ color:#9a3412; }

/* æ­£è§£è‰² */
.cell.firstOk{ background:#ecfdf5; }
.cell.firstOk input{ color:#065f46; }
.cell.lateOk{ background:#eef2ff; }
.cell.lateOk input{ color:#1e3a8a; }

/* â˜… ã“ãŸãˆè¡¨ç¤ºä¸­ */
.cell.revealing{ background:#f8fafc; }
.cell.revealing input{ color:#111827; }

/* â—ï¼ˆæ­£å††ï¼‰ */
.cell.firstOk::before,
.cell.firstOk::after{
  content:"";
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  border-radius:50%;
  pointer-events:none;
}
.cell.firstOk::before{
  width:var(--circleOuter);
  height:var(--circleOuter);
  border:3px solid var(--mark);
}
.cell.firstOk::after{
  width:var(--circleInner);
  height:var(--circleInner);
  border:3px solid var(--mark);
}

/* ã€‡ï¼ˆæ­£å††ï¼‰ */
.cell.lateOk::after{
  content:"";
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  width:var(--circleSingle);
  height:var(--circleSingle);
  border:3px solid var(--mark);
  border-radius:50%;
  pointer-events:none;
}

/* åŠè§’æ³¨æ„ */
.hankakuWarn{
  position:absolute;
  top:-26px;
  left:50%;
  transform:translateX(-50%);
  background:#fee2e2;
  color:#b91c1c;
  font-size:12px;
  font-weight:900;
  padding:4px 8px;
  border-radius:8px;
  white-space:nowrap;
  box-shadow:0 4px 8px rgba(0,0,0,.12);
  display:none;
  z-index:20;
}
.cell.warn .hankakuWarn{ display:block; }

.score{
  margin-top:12px;
  font-weight:1000;
  font-size:18px;
}
</style>
</head>

<body>
<div class="wrap">
  <div class="layout">

    <!-- å·¦ã‚«ãƒ©ãƒ ï¼š81ã¾ã™ -->
    <div class="panel">

      <!-- å•é¡Œã®å·¦ä¸Šï¼šã“ãŸãˆã‚’è¦‹ã‚‹ï¼ˆé•·æŠ¼ã—0.3ç§’ï¼‰ -->
      <div class="leftTopRow">
        <button id="peekBtn" class="peekBtn" type="button" title="ã‚«ãƒ¼ã‚½ãƒ«ãŒã‚ã‚‹ãƒã‚¹ã ã‘ ã“ãŸãˆã‚’è¡¨ç¤ºï¼ˆ0.3ç§’é•·æŠ¼ã—ï¼‰">
          <span>ã“ãŸãˆã‚’è¦‹ã‚‹</span>
        </button>
        <div class="leftHint">â€» 0.3ç§’ é•·æŠ¼ã—ï¼ˆã„ã¾ã®ãƒã‚¹ã ã‘ï¼‰</div>
      </div>

      <div class="masuWrap" id="masuWrap">
        <div style="padding:12px;font-weight:900;color:#6b7280;">å³ã®ã€Œä¸ŠãŒã‚Š / ä¸‹ãŒã‚Š / ãƒãƒ©ãƒãƒ©ã€ã§ 81ã¾ã™ ã‚’ä½œã‚Œã¾ã™ã€‚</div>
      </div>
      <div class="score" id="score">ç‚¹æ•°ï¼šâ€” / 100</div>
    </div>

    <!-- å³ã‚«ãƒ©ãƒ ï¼š7è¡Œ -->
    <div class="card">
      <div class="rightStack">

        <div class="row rowTitle">
          <h1 class="titleText">ä¹ä¹ã®81ã¾ã™è¨ˆç®—ï¼ˆ9Ã—9ï¼‰</h1>
        </div>

        <div class="row">
          <div class="bestGroup" aria-live="polite" title="ãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒ ï¼ˆã“ã®ç«¯æœ«ã«ä¿å­˜ï¼‰">

            <div class="bestBox">
              <button class="bestClearBtn" id="clearBestUpBtn" type="button" title="ä¸ŠãŒã‚Šã®ãƒ™ã‚¹ãƒˆã‚’ã‘ã™">ğŸ—‘</button>
              <div class="bestLeft">
                <span class="bestLabel">ğŸ† ä¸ŠãŒã‚Š</span>
                <span class="bestValue" id="bestUpText">â€”</span>
                <span class="bestLabel">ã³ã‚‡ã†</span>
              </div>
            </div>

            <div class="bestBox">
              <button class="bestClearBtn" id="clearBestDownBtn" type="button" title="ä¸‹ãŒã‚Šã®ãƒ™ã‚¹ãƒˆã‚’ã‘ã™">ğŸ—‘</button>
              <div class="bestLeft">
                <span class="bestLabel">ğŸ† ä¸‹ãŒã‚Š</span>
                <span class="bestValue" id="bestDownText">â€”</span>
                <span class="bestLabel">ã³ã‚‡ã†</span>
              </div>
            </div>

            <div class="bestBox">
              <button class="bestClearBtn" id="clearBestRandBtn" type="button" title="ãƒãƒ©ãƒãƒ©ã®ãƒ™ã‚¹ãƒˆã‚’ã‘ã™">ğŸ—‘</button>
              <div class="bestLeft">
                <span class="bestLabel">ğŸ† ãƒãƒ©ãƒãƒ©</span>
                <span class="bestValue" id="bestRandText">â€”</span>
                <span class="bestLabel">ã³ã‚‡ã†</span>
              </div>
            </div>

          </div>
        </div>

        <div class="row">
          <button class="primary" id="checkBtn">ã“ãŸãˆã‚ã‚ã›</button>
        </div>

        <div class="row" id="timerInline">
          <div class="timer" id="timerBox" aria-live="polite">
            <div class="left">
              <span class="label">â± ã‚¿ã‚¤ãƒ </span>
              <span class="value" id="timerText">0.0</span>
              <span class="label">ã³ã‚‡ã†</span>
            </div>
            <div class="hint" id="timerHint">ãƒœã‚¿ãƒ³ã§ã‚¹ã‚¿ãƒ¼ãƒˆ</div>
          </div>
        </div>

        <div class="row">
          <label class="switch" title="ã‚¿ã‚¤ãƒ ã‚’è¨ˆæ¸¬ã™ã‚‹/ã—ãªã„">
            <input type="checkbox" id="timingToggle" checked>
            ã‚¿ã‚¤ãƒ ã‚’ã¯ã‹ã‚‹
          </label>
        </div>

        <div class="row">
          <div class="makeBtns">
            <button id="makeUpBtn">ä¸ŠãŒã‚Š</button>
            <button id="makeDownBtn">ä¸‹ãŒã‚Š</button>
            <button id="makeRandBtn">ãƒãƒ©ãƒãƒ©</button>
          </div>
        </div>

        <div class="row">
          <div style="width:100%;">
            <div class="errBar" id="errBar">ã‚¨ãƒ©ãƒ¼ï¼š</div>
            <div class="note" style="margin-top:10px;">
              ãƒ»ã€Œã“ãŸãˆã‚’è¦‹ã‚‹ã€ã¯ 0.3ç§’ é•·æŠ¼ã—ã§è¡¨ç¤ºï¼ˆã‚«ãƒ¼ã‚½ãƒ«ã®ã‚ã‚‹ãƒã‚¹ã ã‘ï¼‰<br>
              ãƒ»60ç§’ã‚’è¶…ãˆãŸã‚‰ã€Œâ—‹åˆ† â—‹ç§’ã€ã§è¡¨ç¤º<br>
              ãƒ»å…¥åŠ›ã—ãŸã‚‰è‡ªå‹•ã§æ¬¡ã®ãƒã‚¹ã¸ï¼ˆæ­£è§£ã®æ¡æ•°ã¶ã‚“å…¥åŠ›ã•ã‚ŒãŸã‚‰ç§»å‹•ï¼‰<br>
              ãƒ»ã“ãŸãˆã‚ã‚ã›ã§ã€1ç™ºæ­£è§£ã¯â—ã€2å›ç›®ä»¥é™æ­£è§£ã¯ã€‡ï¼ˆè‰²ã‚‚å¤‰åŒ–ï¼‰<br>
              ãƒ»ã€Œã“ãŸãˆã‚’è¦‹ã‚‹ã€ã‚’ä½¿ã£ãŸãƒã‚¹ã¯ â—ã«ãªã‚‰ãš ã€‡ã‚ã¤ã‹ã„<br>
              ãƒ»Enterã§æ¬¡ã®ãƒã‚¹ã€Shift+Enterã§å‰ã®ãƒã‚¹<br>
              ãƒ»â†â†’â†‘â†“ã§ä¸Šä¸‹å·¦å³ã«ç§»å‹•ï¼ˆç«¯ã¯å›ã‚Šè¾¼ã¿ï¼‰<br>
              ãƒ»81ã¾ã™ãœã‚“ã¶æ­£è§£ã§è‡ªå‹•ã‚¹ãƒˆãƒƒãƒ—ï¼ˆã‚¿ã‚¤ãƒ ONã®ã¨ãï¼‰
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>

<script>
/* ===== ã‚¨ãƒ©ãƒ¼è¡¨ç¤º ===== */
(function(){
  const bar = document.getElementById("errBar");
  window.addEventListener("error", (e)=>{
    if(!bar) return;
    bar.style.display = "block";
    bar.textContent = "ã‚¨ãƒ©ãƒ¼ï¼š" + (e.message || "unknown") + "ï¼ˆ" + (e.filename||"") + ":" + (e.lineno||"") + "ï¼‰";
  });
})();

function toHalfWidth(str){
  return String(str).replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
}
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

/* 60ç§’ä»¥ä¸Šã¯ã€Œâ—‹åˆ†â—‹ç§’ã€è¡¨ç¤º */
function fmtTime(sec){
  if(!Number.isFinite(sec)) return "â€”";
  if(sec < 60) return sec.toFixed(1);
  const m = Math.floor(sec / 60);
  const s = sec - m*60;
  const ss = s.toFixed(1).padStart(4, "0");
  return `${m}åˆ† ${ss}`;
}

/* è¨­å®š */
const SIZE = 9;
const ASC = [1,2,3,4,5,6,7,8,9];
const DESC = [9,8,7,6,5,4,3,2,1];

/* ã‚¿ã‚¤ãƒ è¨ˆæ¸¬ ON/OFF */
let timingEnabled = true;
const timingToggle = document.getElementById("timingToggle");
const timerInline = document.getElementById("timerInline");

/* ãƒ™ã‚¹ãƒˆï¼ˆ3ç¨®é¡ãƒ»å¸¸æ™‚è¡¨ç¤ºï¼‰ */
const BEST_KEYS = {
  up:   "hyakumasu_kuku_9x9_best_up_v1",
  down: "hyakumasu_kuku_9x9_best_down_v1",
  rand: "hyakumasu_kuku_9x9_best_rand_v1",
};
const bestUpText = document.getElementById("bestUpText");
const bestDownText = document.getElementById("bestDownText");
const bestRandText = document.getElementById("bestRandText");

function loadBest(mode){
  const key = BEST_KEYS[mode];
  const v = localStorage.getItem(key);
  if(!v) return null;
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
}
function setBestText(el, v){
  el.textContent = (v==null) ? "â€”" : fmtTime(v);
}
function showAllBests(){
  setBestText(bestUpText, loadBest("up"));
  setBestText(bestDownText, loadBest("down"));
  setBestText(bestRandText, loadBest("rand"));
}
function tryUpdateBest(mode, sec){
  const best = loadBest(mode);
  if(best==null || sec < best){
    localStorage.setItem(BEST_KEYS[mode], String(sec));
    showAllBests();
  }
}
function clearBest(mode){
  const name = (mode==="up"?"ä¸ŠãŒã‚Š":mode==="down"?"ä¸‹ãŒã‚Š":"ãƒãƒ©ãƒãƒ©");
  if(confirm(`ã€Œ${name}ã€ã®ãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã‚’ã‘ã—ã¾ã™ã‹ï¼Ÿ`)){
    try{ localStorage.removeItem(BEST_KEYS[mode]); }catch(e){}
    showAllBests();
  }
}
document.getElementById("clearBestUpBtn").addEventListener("click", ()=>clearBest("up"));
document.getElementById("clearBestDownBtn").addEventListener("click", ()=>clearBest("down"));
document.getElementById("clearBestRandBtn").addEventListener("click", ()=>clearBest("rand"));

/* ã‚¿ã‚¤ãƒãƒ¼ */
let tStart = null;
let tStop = null;
let tTick = null;

const timerBox = document.getElementById("timerBox");
const timerText = document.getElementById("timerText");
const timerHint = document.getElementById("timerHint");

function timerReset(){
  tStart = null;
  tStop = null;
  timerText.textContent = "0.0";
  timerBox.classList.remove("running");
  timerHint.textContent = "ãƒœã‚¿ãƒ³ã§ã‚¹ã‚¿ãƒ¼ãƒˆ";
  if(tTick){ clearInterval(tTick); tTick = null; }
}
function timerStart(){
  if(!timingEnabled) return;
  tStart = performance.now();
  tStop = null;
  timerBox.classList.add("running");
  timerHint.textContent = "ãœã‚“ã¶ ã›ã„ã‹ã„ ã§ã‚¹ãƒˆãƒƒãƒ—ï¼";
  if(tTick) clearInterval(tTick);
  tTick = setInterval(()=>{
    if(tStart==null || tStop!=null) return;
    const sec = (performance.now() - tStart)/1000;
    timerText.textContent = fmtTime(sec);
  }, 100);
}
function timerStop(){
  if(!timingEnabled) return;
  if(tStart==null || tStop!=null) return;

  tStop = performance.now();
  const sec = (tStop - tStart) / 1000;

  timerText.textContent = fmtTime(sec);
  timerBox.classList.remove("running");
  timerHint.textContent = "ğŸ‰ ãŠã‚ã‚Šï¼ã‚‚ã†ã„ã¡ã© ã¯ä½œæˆãƒœã‚¿ãƒ³";
  if(tTick){ clearInterval(tTick); tTick = null; }

  tryUpdateBest(currentMode, sec);
}
function setTimingUI(){
  timingEnabled = timingToggle.checked;
  timerReset();
  timerInline.classList.toggle("timerOff", !timingEnabled);
}
timingToggle.addEventListener("change", setTimingUI);

/* 81ã¾ã™ãƒ‡ãƒ¼ã‚¿ */
let topNums = [];
let leftNums = [];
let answers = [];

let wrongChecks = [];
let solved = [];
let usedPeek = [];

let currentMode = "up";
let lastFocusedInput = null;

function makeNums(mode){
  if(mode === "up") return ASC.slice();
  if(mode === "down") return DESC.slice();
  return shuffle(ASC.slice());
}
function buildAnswers(){
  const out = Array.from({length:SIZE}, ()=>Array(SIZE).fill(0));
  for(let r=0;r<SIZE;r++){
    for(let c=0;c<SIZE;c++){
      out[r][c] = leftNums[r] * topNums[c];
    }
  }
  answers = out;
}

/* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç§»å‹• */
function getInputs(){
  return Array.from(document.querySelectorAll(".masuInput"));
}
function focusByRC(r, c){
  const rr = ((r % SIZE) + SIZE) % SIZE;
  const cc = ((c % SIZE) + SIZE) % SIZE;
  const inp = document.querySelector(`.cell[data-r="${rr}"][data-c="${cc}"] .masuInput`);
  if(!inp) return;
  inp.focus();
  inp.select?.();
}
function focusByIndex(index){
  const inputs = getInputs();
  if(inputs.length === 0) return;
  const i = ((index % inputs.length) + inputs.length) % inputs.length;
  inputs[i].focus();
  inputs[i].select?.();
}

/* å…¥åŠ›ã—ãŸã‚‰æ¬¡ã¸ï¼ˆæ­£è§£ã®æ¡æ•°ã¶ã‚“å…¥ã£ãŸã‚‰ç§»å‹•ï¼‰ */
function maybeAutoAdvanceByExpectedLen(inp){
  const cell = inp.closest(".cell");
  if(!cell) return;
  if(document.querySelectorAll(".cell").length !== SIZE*SIZE) return;
  if(!answers || answers.length !== SIZE) return;

  const r = Number(cell.dataset.r);
  const c = Number(cell.dataset.c);
  const expected = answers[r]?.[c];
  if(!Number.isFinite(expected)) return;

  const needLen = String(expected).length;
  const nowLen = inp.value.trim().length;

  if(nowLen >= needLen){
    const inputs = getInputs();
    const idx = inputs.indexOf(inp);
    if(idx >= 0) focusByIndex(idx + 1);
  }
}

/* ã‚­ãƒ¼æ“ä½œï¼šEnter & çŸ¢å° */
function handleKeyNav(e){
  const key = e.key;

  if(key === "Enter"){
    e.preventDefault();
    const inputs = getInputs();
    const idx = inputs.indexOf(e.target);
    if(idx < 0) return;
    focusByIndex(idx + (e.shiftKey ? -1 : 1));
    return;
  }

  if(key !== "ArrowLeft" && key !== "ArrowRight" && key !== "ArrowUp" && key !== "ArrowDown") return;

  e.preventDefault();

  const cell = e.target.closest(".cell");
  if(!cell) return;
  let r = Number(cell.dataset.r);
  let c = Number(cell.dataset.c);

  if(key === "ArrowLeft")  c--;
  if(key === "ArrowRight") c++;
  if(key === "ArrowUp")    r--;
  if(key === "ArrowDown")  r++;

  focusByRC(r, c);
}

/* ã“ãŸãˆã‚’è¦‹ã‚‹ï¼ˆé•·æŠ¼ã—0.3ç§’ï¼‰ */
const LONG_PRESS_MS = 300;
let peekHolding = false;
let peekSaved = { inp:null, value:"", readOnly:false, cell:null };
let peekPressing = false;
let peekTimer = null;

function hasGrid(){
  return document.querySelectorAll(".cell").length === SIZE*SIZE;
}
function startPeekNow(){
  if(peekHolding) return;
  if(!hasGrid()) return;

  let inp = lastFocusedInput;
  if(!inp || !inp.classList.contains("masuInput")){
    focusByRC(0,0);
    inp = lastFocusedInput;
    if(!inp) return;
  }

  const cell = inp.closest(".cell");
  if(!cell) return;

  const r = Number(cell.dataset.r);
  const c = Number(cell.dataset.c);
  const expected = answers?.[r]?.[c];
  if(!Number.isFinite(expected)) return;

  const idx = r*SIZE + c;
  if(idx >= 0) usedPeek[idx] = true;

  peekHolding = true;
  peekSaved = { inp, value: inp.value, readOnly: inp.readOnly, cell };

  inp.value = String(expected);
  inp.readOnly = true;
  cell.classList.add("revealing");
}
function stopPeek(){
  if(peekTimer){ clearTimeout(peekTimer); peekTimer = null; }
  peekPressing = false;

  if(!peekHolding) return;
  peekHolding = false;

  const { inp, value, readOnly, cell } = peekSaved;
  if(inp){
    inp.value = value;
    inp.readOnly = readOnly;
  }
  if(cell) cell.classList.remove("revealing");

  peekSaved = { inp:null, value:"", readOnly:false, cell:null };
}
function pressPeek(e){
  e.preventDefault();
  if(peekPressing) return;
  peekPressing = true;

  peekTimer = setTimeout(()=>{
    peekTimer = null;
    if(peekPressing) startPeekNow();
  }, LONG_PRESS_MS);
}
function releasePeek(e){
  e?.preventDefault?.();
  stopPeek();
}

const peekBtn = document.getElementById("peekBtn");
peekBtn.addEventListener("mousedown", pressPeek);
window.addEventListener("mouseup", releasePeek);
peekBtn.addEventListener("mouseleave", releasePeek);

peekBtn.addEventListener("touchstart", pressPeek, {passive:false});
window.addEventListener("touchend", releasePeek, {passive:false});
window.addEventListener("touchcancel", releasePeek, {passive:false});

/* æç”» */
function render(){
  const wrap = document.getElementById("masuWrap");
  wrap.innerHTML = "";

  const table = document.createElement("table");

  const tr0 = document.createElement("tr");
  const corner = document.createElement("th");
  corner.className = "corner top left";
  corner.textContent = "Ã—";
  tr0.appendChild(corner);

  for(let c=0;c<SIZE;c++){
    const th = document.createElement("th");
    th.className = "top";
    th.textContent = topNums[c];
    tr0.appendChild(th);
  }
  table.appendChild(tr0);

  for(let r=0;r<SIZE;r++){
    const tr = document.createElement("tr");

    const thL = document.createElement("th");
    thL.className = "left";
    thL.textContent = leftNums[r];
    tr.appendChild(thL);

    for(let c=0;c<SIZE;c++){
      const td = document.createElement("td");

      const cell = document.createElement("div");
      cell.className = "cell";
      cell.dataset.r = String(r);
      cell.dataset.c = String(c);

      cell.innerHTML = `
        <span class="hankakuWarn">åŠè§’æ•°å­—ã§å…¥åŠ›ã—ã¦ã­</span>
        <input class="masuInput" inputmode="numeric" aria-label="ã¾ã™ ${r+1}-${c+1}">
      `;

      const inp = cell.querySelector("input");

      inp.addEventListener("focus", ()=>{
        lastFocusedInput = inp;
      });

      inp.addEventListener("input",(e)=>{
        const before = e.target.value;
        const after = toHalfWidth(before);

        if(before !== after){
          cell.classList.add("warn");
          clearTimeout(cell._warnTimer);
          cell._warnTimer = setTimeout(()=> cell.classList.remove("warn"), 1500);
        }
        e.target.value = after;

        cell.classList.remove("bad");
        maybeAutoAdvanceByExpectedLen(inp);
        maybeStopTimerIfAllCorrect();
      });

      inp.addEventListener("keydown", handleKeyNav);

      td.appendChild(cell);
      tr.appendChild(td);
    }

    table.appendChild(tr);
  }

  wrap.appendChild(table);
  document.getElementById("score").textContent = "ç‚¹æ•°ï¼šâ€” / 100";

  setTimeout(()=> focusByRC(0,0), 0);
}

/* å…¨å•æ­£è§£åˆ¤å®š */
function allCorrect(){
  if(!hasGrid()) return false;
  const cells = document.querySelectorAll(".cell");
  for(const cell of cells){
    const r = Number(cell.dataset.r);
    const c = Number(cell.dataset.c);
    const v = Number(cell.querySelector("input").value);
    if(!Number.isFinite(v)) return false;
    if(v !== answers[r][c]) return false;
  }
  return true;
}
function maybeStopTimerIfAllCorrect(){
  if(!timingEnabled) return;
  if(tStart==null || tStop!=null) return;
  if(allCorrect()) timerStop();
}

/* ã“ãŸãˆã‚ã‚ã› */
function check(){
  if(!hasGrid()){
    document.getElementById("score").textContent = "ç‚¹æ•°ï¼šâ€” / 100";
    return;
  }

  const cells = document.querySelectorAll(".cell");
  let okCount = 0;

  for(const cell of cells){
    const r = Number(cell.dataset.r);
    const c = Number(cell.dataset.c);
    const idx = r*SIZE + c;

    const inp = cell.querySelector("input");
    const raw = inp.value.trim();
    const v = Number(raw);

    const correct = (Number.isFinite(v) && v === answers[r][c]);

    if(solved[idx]){
      okCount++;
      continue;
    }

    cell.classList.remove("bad","firstOk","lateOk");

    if(correct){
      solved[idx] = true;

      const isFirstTry = (wrongChecks[idx] === 0) && !usedPeek[idx];
      if(isFirstTry){
        cell.classList.add("firstOk");
      }else{
        cell.classList.add("lateOk");
      }
      okCount++;
    }else{
      if(raw !== ""){
        wrongChecks[idx]++;
        cell.classList.add("bad");
      }
    }
  }

  const score = Math.round((okCount / (SIZE*SIZE)) * 100);
  document.getElementById("score").textContent = `ç‚¹æ•°ï¼š${score} / 100`;

  maybeStopTimerIfAllCorrect();
}

/* ã‚¿ã‚¤ãƒ UI */
function timerReset(){
  tStart = null;
  tStop = null;
  timerText.textContent = "0.0";
  timerBox.classList.remove("running");
  timerHint.textContent = "ãƒœã‚¿ãƒ³ã§ã‚¹ã‚¿ãƒ¼ãƒˆ";
  if(tTick){ clearInterval(tTick); tTick = null; }
}
function timerStart(){
  if(!timingEnabled) return;
  tStart = performance.now();
  tStop = null;
  timerBox.classList.add("running");
  timerHint.textContent = "ãœã‚“ã¶ ã›ã„ã‹ã„ ã§ã‚¹ãƒˆãƒƒãƒ—ï¼";
  if(tTick) clearInterval(tTick);
  tTick = setInterval(()=>{
    if(tStart==null || tStop!=null) return;
    const sec = (performance.now() - tStart)/1000;
    timerText.textContent = fmtTime(sec);
  }, 100);
}
function timerStop(){
  if(!timingEnabled) return;
  if(tStart==null || tStop!=null) return;

  tStop = performance.now();
  const sec = (tStop - tStart) / 1000;

  timerText.textContent = fmtTime(sec);
  timerBox.classList.remove("running");
  timerHint.textContent = "ğŸ‰ ãŠã‚ã‚Šï¼ã‚‚ã†ã„ã¡ã© ã¯ä½œæˆãƒœã‚¿ãƒ³";
  if(tTick){ clearInterval(tTick); tTick = null; }

  tryUpdateBest(currentMode, sec);
}
function setTimingUI(){
  timingEnabled = timingToggle.checked;
  timerReset();
  timerInline.classList.toggle("timerOff", !timingEnabled);
}

/* å•é¡Œä½œæˆ */
function make(mode){
  currentMode = mode;

  topNums = makeNums(mode);
  leftNums = makeNums(mode);
  buildAnswers();

  wrongChecks = Array(SIZE*SIZE).fill(0);
  solved = Array(SIZE*SIZE).fill(false);
  usedPeek = Array(SIZE*SIZE).fill(false);

  lastFocusedInput = null;
  stopPeek();

  render();

  timerReset();
  timerStart();
}

/* ã‚¤ãƒ™ãƒ³ãƒˆ */
document.getElementById("makeUpBtn").addEventListener("click", ()=>make("up"));
document.getElementById("makeDownBtn").addEventListener("click", ()=>make("down"));
document.getElementById("makeRandBtn").addEventListener("click", ()=>make("rand"));
document.getElementById("checkBtn").addEventListener("click", check);
timingToggle.addEventListener("change", setTimingUI);

/* åˆæœŸåŒ– */
showAllBests();
setTimingUI();
</script>
</body>
</html>
