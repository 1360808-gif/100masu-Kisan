<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ä¹ä¹ã®ç™¾ã¾ã™è¨ˆç®—</title>

<style>
:root{
  --bg:#f7f8ff;
  --ink:#1f2937;
  --line:#e5e7eb;
  --accent:#4f46e5;
  --shadow:0 10px 24px rgba(0,0,0,.08);
}
*{ box-sizing:border-box; }

body{
  margin:0;
  font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif;
  background:var(--bg);
  color:var(--ink);
}
.wrap{ max-width:1200px; margin:16px auto; padding:0 12px 40px; }

.top{
  background:#fff;
  border:1px solid var(--line);
  border-radius:24px;
  padding:14px;
  box-shadow:var(--shadow);
}

/* ===== ã‚¿ã‚¤ãƒˆãƒ«è¡Œï¼ˆå³ã«ãƒ™ã‚¹ãƒˆï¼‰ ===== */
.titleRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  flex-wrap:nowrap;
}
.titleRow h1{
  margin:0;
  font-size:22px;
  white-space:nowrap;
}

/* ãƒ™ã‚¹ãƒˆ */
.bestBox{
  display:inline-flex;
  align-items:baseline;
  gap:8px;
  padding:8px 12px;
  border-radius:14px;
  border:1px dashed rgba(79,70,229,.55);
  background:#fbfbff;
  font-weight:1000;
  white-space:nowrap;
}
.bestBox .label{ font-size:13px; opacity:.85; }
.bestBox .value{ font-size:20px; letter-spacing:.4px; }
.bestClearBtn{
  padding:6px 8px;
  border-radius:10px;
  border:1px solid var(--line);
  background:#fff;
  font-weight:900;
  cursor:pointer;
  line-height:1;
}
.bestClearBtn:hover{ background:#fee2e2; }
.bestClearBtn:active{ transform: translateY(1px); }

/* ===== ä¸Šéƒ¨ï¼š1è¡Œï¼ˆãƒœã‚¿ãƒ³é¡ï¼‰ ===== */
.controlsRow{
  margin-top:10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  flex-wrap:nowrap;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
}
.controlsLeft, .controlsRight{
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:nowrap;
}

button{
  padding:9px 12px;
  border-radius:12px;
  border:1px solid var(--line);
  background:#fff;
  font-weight:900;
  cursor:pointer;
}
button.primary{
  background:var(--accent);
  border-color:transparent;
  color:#fff;
}
button:active{ transform: translateY(1px); }

.panel{
  margin-top:12px;
  background:#fff;
  border:1px solid var(--line);
  border-radius:18px;
  padding:14px;
  box-shadow:0 6px 12px rgba(0,0,0,.06);
}

/* ===== ã‚¿ã‚¤ãƒ è¡¨ç¤º ===== */
.timerInline{
  display:flex;
  align-items:center;
  gap:10px;
  flex:0 0 auto;
  white-space:nowrap;
}
.timer{
  display:inline-flex;
  align-items:baseline;
  gap:8px;
  padding:8px 12px;
  border-radius:14px;
  border:1px solid var(--line);
  background:#f8fafc;
  font-weight:1000;
}
.timer .label{ font-size:13px; opacity:.85; }
.timer .value{ font-size:20px; letter-spacing:.5px; }
.timer.running{
  border-color: rgba(79,70,229,.45);
  box-shadow: 0 0 0 3px rgba(79,70,229,.12);
}
.hint{
  color:#6b7280;
  font-weight:800;
  font-size:13px;
}
.timerOff{ display:none; }

/* è¨ˆæ¸¬ON/OFF */
.switch{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:7px 10px;
  border-radius:12px;
  border:1px solid var(--line);
  background:#fff;
  font-weight:900;
  cursor:pointer;
  user-select:none;
  -webkit-user-select:none;
  white-space:nowrap;
}
.switch input{ accent-color: var(--accent); }

/* ===== ç™¾ã¾ã™ ===== */
.masuWrap{
  overflow:auto;
  border:1px solid var(--line);
  border-radius:16px;
  background:#fff;
}

table{
  border-collapse:separate;
  border-spacing:0;
  width:max-content;
  min-width:100%;
}
th, td{
  border-right:1px solid var(--line);
  border-bottom:1px solid var(--line);
  padding:0;
}
tr:first-child th{
  border-top:1px solid var(--line);
}
th:first-child, td:first-child{
  border-left:1px solid var(--line);
}
th{
  background:#f8fafc;
  font-weight:1000;
  text-align:center;
  width:52px;
  height:44px;
  position:sticky;
  z-index:2;
}
th.top{
  top:0;
}
th.left{
  left:0;
  z-index:3;
}
th.corner{
  top:0; left:0;
  z-index:4;
  background:#eef2ff;
}

td{
  width:52px;
  height:44px;
  background:#fff;
}

.cell{
  position:relative;
  width:52px;
  height:44px;
}
.cell input{
  width:100%;
  height:100%;
  border:0;
  outline:none;
  text-align:center;
  font-size:16px;
  font-weight:1000;
  background:transparent;
}
.cell.ok{
  background:#ecfdf5;
}
.cell.ok input{
  color:#065f46;
}
.cell.bad{
  background:#fff7ed;
}
.cell.bad input{
  color:#9a3412;
}

/* åŠè§’æ³¨æ„ï¼ˆå¿…è¦ãªã‚‰å‡ºã™ï¼‰ */
.hankakuWarn{
  position:absolute;
  top:-26px;
  left:50%;
  transform:translateX(-50%);
  background:#fee2e2;
  color:#b91c1c;
  font-size:12px;
  font-weight:900;
  padding:4px 8px;
  border-radius:8px;
  white-space:nowrap;
  box-shadow:0 4px 8px rgba(0,0,0,.12);
  display:none;
  z-index:20;
}
.cell.warn .hankakuWarn{ display:block; }

.score{
  margin-top:12px;
  font-weight:1000;
  font-size:18px;
}

/* ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºï¼ˆä½•ã‚‚å‡ºãªã„æ™‚ç”¨ï¼‰ */
.errBar{
  margin-top:10px;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid #fecaca;
  background:#fff1f2;
  color:#991b1b;
  font-weight:900;
  display:none;
}
</style>
</head>

<body>
<div class="wrap">

  <div class="top">
    <div class="titleRow">
      <h1>ä¹ä¹ã®ç™¾ã¾ã™è¨ˆç®—ï¼ˆ10Ã—10ï¼‰</h1>

      <div class="bestBox" id="bestInline" aria-live="polite" title="ãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒ ï¼ˆã“ã®ç«¯æœ«ã«ä¿å­˜ï¼‰">
        <button id="clearBestBtn" class="bestClearBtn" type="button" title="ãƒ™ã‚¹ãƒˆã‚’ã‘ã™">ğŸ—‘</button>
        <span class="label">ğŸ† ãƒ™ã‚¹ãƒˆ</span>
        <span class="value" id="bestText">â€”</span>
        <span class="label">ã³ã‚‡ã†</span>
      </div>
    </div>

    <div class="controlsRow">
      <div class="controlsLeft">
        <button class="primary" id="checkBtn">ã“ãŸãˆã‚ã‚ã›</button>
      </div>

      <div class="timerInline" id="timerInline">
        <div class="timer" id="timerBox" aria-live="polite">
          <span class="label">â± ã‚¿ã‚¤ãƒ </span>
          <span class="value" id="timerText">0.0</span>
          <span class="label">ã³ã‚‡ã†</span>
        </div>
        <div class="hint" id="timerHint">ã€Œã‚‚ã‚“ã ã„ã‚’ã¤ãã‚‹ã€ã§ã‚¹ã‚¿ãƒ¼ãƒˆ</div>
      </div>

      <div class="controlsRight">
        <label class="switch" title="ã‚¿ã‚¤ãƒ ã‚’è¨ˆæ¸¬ã™ã‚‹/ã—ãªã„">
          <input type="checkbox" id="timingToggle" checked>
          ã‚¿ã‚¤ãƒ 
        </label>
        <button id="makeBtn">ã‚‚ã‚“ã ã„ã‚’ã¤ãã‚‹</button>
      </div>
    </div>

    <div class="errBar" id="errBar">ã‚¨ãƒ©ãƒ¼ï¼š</div>
  </div>

  <div class="panel">
    <div class="masuWrap" id="masuWrap">
      <div style="padding:12px;font-weight:900;color:#6b7280;">ã€Œã‚‚ã‚“ã ã„ã‚’ã¤ãã‚‹ã€ã‚’æŠ¼ã™ã¨ç™¾ã¾ã™ãŒå‡ºã¾ã™ã€‚</div>
    </div>
    <div class="score" id="score">ç‚¹æ•°ï¼šâ€” / 100</div>
  </div>

</div>

<script>
/* ===== ä½•ã‚‚è¡¨ç¤ºã•ã‚Œãªã„æ™‚ç”¨ï¼šã‚¨ãƒ©ãƒ¼ã‚’ç”»é¢ã«å‡ºã™ ===== */
(function(){
  const bar = document.getElementById("errBar");
  window.addEventListener("error", (e)=>{
    if(!bar) return;
    bar.style.display = "block";
    bar.textContent = "ã‚¨ãƒ©ãƒ¼ï¼š" + (e.message || "unknown") + "ï¼ˆ" + (e.filename||"") + ":" + (e.lineno||"") + "ï¼‰";
  });
})();

function toHalfWidth(str){
  return String(str).replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
}
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}
function randInt(min,max){
  return Math.floor(Math.random()*(max-min+1))+min;
}

/* ===== è¨­å®š ===== */
const SIZE = 10;        // 10Ã—10 = 100ã¾ã™
const KUKU_MIN = 1;     // ä¹ä¹
const KUKU_MAX = 9;

/* ===== ã‚¿ã‚¤ãƒ è¨ˆæ¸¬ ON/OFF ===== */
let timingEnabled = true;
const timingToggle = document.getElementById("timingToggle");
const timerInline = document.getElementById("timerInline");

/* ===== ãƒ™ã‚¹ãƒˆï¼ˆlocalStorageï¼‰ ===== */
const BEST_KEY = "hyakumasu_kuku_best_sec_v1";
const bestText = document.getElementById("bestText");

function loadBest(){
  const v = localStorage.getItem(BEST_KEY);
  if(!v) return null;
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
}
function showBest(){
  const best = loadBest();
  bestText.textContent = (best==null) ? "â€”" : best.toFixed(1);
}
function tryUpdateBest(sec){
  const best = loadBest();
  if(best==null || sec < best){
    localStorage.setItem(BEST_KEY, String(sec));
    showBest();
  }
}
function clearBest(){
  if(confirm("ãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã‚’ã‘ã—ã¾ã™ã‹ï¼Ÿ")){
    try{ localStorage.removeItem(BEST_KEY); }catch(e){}
    showBest();
  }
}
document.getElementById("clearBestBtn").addEventListener("click", clearBest);

/* ===== å…¨å•ã‚¿ã‚¤ãƒãƒ¼ ===== */
let tStart = null;
let tStop = null;
let tTick = null;

const timerBox = document.getElementById("timerBox");
const timerText = document.getElementById("timerText");
const timerHint = document.getElementById("timerHint");

function timerReset(){
  tStart = null;
  tStop = null;
  timerText.textContent = "0.0";
  timerBox.classList.remove("running");
  timerHint.textContent = "ã€Œã‚‚ã‚“ã ã„ã‚’ã¤ãã‚‹ã€ã§ã‚¹ã‚¿ãƒ¼ãƒˆ";
  if(tTick){ clearInterval(tTick); tTick = null; }
}
function timerStart(){
  if(!timingEnabled) return;
  tStart = performance.now();
  tStop = null;
  timerBox.classList.add("running");
  timerHint.textContent = "ãœã‚“ã¶ ã›ã„ã‹ã„ ã§ã‚¹ãƒˆãƒƒãƒ—ï¼";
  if(tTick) clearInterval(tTick);
  tTick = setInterval(()=>{
    if(tStart==null || tStop!=null) return;
    timerText.textContent = ((performance.now() - tStart) / 1000).toFixed(1);
  }, 100);
}
function timerStop(){
  if(!timingEnabled) return;
  if(tStart==null || tStop!=null) return;

  tStop = performance.now();
  const sec = (tStop - tStart) / 1000;

  timerText.textContent = sec.toFixed(1);
  timerBox.classList.remove("running");
  timerHint.textContent = "ğŸ‰ ãŠã‚ã‚Šï¼ã‚‚ã†ã„ã¡ã© ã¯ã€Œã‚‚ã‚“ã ã„ã‚’ã¤ãã‚‹ã€";
  if(tTick){ clearInterval(tTick); tTick = null; }

  tryUpdateBest(sec);
}
function setTimingUI(){
  timingEnabled = timingToggle.checked;
  timerReset();
  timerInline.classList.toggle("timerOff", !timingEnabled);
}
timingToggle.addEventListener("change", setTimingUI);

/* ===== ç™¾ã¾ã™ãƒ‡ãƒ¼ã‚¿ ===== */
let topNums = [];
let leftNums = [];
let answers = []; // 10x10

function makeHeaderNums(){
  // 1ã€œ9ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«10å€‹ï¼ˆé‡è¤‡ã‚ã‚Šï¼‰
  const a = [];
  for(let i=0;i<SIZE;i++){
    a.push(randInt(KUKU_MIN, KUKU_MAX));
  }
  return a;
}
function buildAnswers(){
  const out = Array.from({length:SIZE}, ()=>Array(SIZE).fill(0));
  for(let r=0;r<SIZE;r++){
    for(let c=0;c<SIZE;c++){
      out[r][c] = leftNums[r] * topNums[c];
    }
  }
  answers = out;
}

/* ===== æç”» ===== */
function render(){
  const wrap = document.getElementById("masuWrap");
  wrap.innerHTML = "";

  const table = document.createElement("table");

  // header row
  const tr0 = document.createElement("tr");
  const corner = document.createElement("th");
  corner.className = "corner top left";
  corner.textContent = "Ã—";
  tr0.appendChild(corner);

  for(let c=0;c<SIZE;c++){
    const th = document.createElement("th");
    th.className = "top";
    th.textContent = topNums[c];
    tr0.appendChild(th);
  }
  table.appendChild(tr0);

  // rows
  for(let r=0;r<SIZE;r++){
    const tr = document.createElement("tr");

    const thL = document.createElement("th");
    thL.className = "left";
    thL.textContent = leftNums[r];
    tr.appendChild(thL);

    for(let c=0;c<SIZE;c++){
      const td = document.createElement("td");
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.dataset.r = String(r);
      cell.dataset.c = String(c);

      cell.innerHTML = `
        <span class="hankakuWarn">åŠè§’æ•°å­—ã§å…¥åŠ›ã—ã¦ã­</span>
        <input class="masuInput" inputmode="numeric" aria-label="ã¾ã™ ${r+1}-${c+1}">
      `;

      const inp = cell.querySelector("input");

      inp.addEventListener("input",(e)=>{
        const before = e.target.value;
        const after = toHalfWidth(before);

        if(before !== after){
          cell.classList.add("warn");
          clearTimeout(cell._warnTimer);
          cell._warnTimer = setTimeout(()=> cell.classList.remove("warn"), 1500);
        }
        e.target.value = after;

        // å…¥åŠ›ä¸­ã®è¦‹ãŸç›®ãƒªã‚»ãƒƒãƒˆ
        cell.classList.remove("ok","bad");

        maybeStopTimerIfAllCorrect();
      });

      td.appendChild(cell);
      tr.appendChild(td);
    }
    table.appendChild(tr);
  }

  wrap.appendChild(table);

  // ã‚¹ã‚³ã‚¢è¡¨ç¤ºãƒªã‚»ãƒƒãƒˆ
  document.getElementById("score").textContent = "ç‚¹æ•°ï¼šâ€” / 100";
}

/* ===== å…¨å•æ­£è§£åˆ¤å®š ===== */
function allCorrect(){
  const cells = document.querySelectorAll(".cell");
  if(cells.length !== SIZE*SIZE) return false;

  for(const cell of cells){
    const r = Number(cell.dataset.r);
    const c = Number(cell.dataset.c);
    const v = Number(cell.querySelector("input").value);
    if(!Number.isFinite(v)) return false;
    if(v !== answers[r][c]) return false;
  }
  return true;
}

function maybeStopTimerIfAllCorrect(){
  if(!timingEnabled) return;
  if(tStart==null || tStop!=null) return;
  if(allCorrect()) timerStop();
}

/* ===== ã“ãŸãˆã‚ã‚ã› ===== */
function check(){
  const cells = document.querySelectorAll(".cell");
  let ok = 0;

  for(const cell of cells){
    const r = Number(cell.dataset.r);
    const c = Number(cell.dataset.c);
    const v = Number(cell.querySelector("input").value);

    cell.classList.remove("ok","bad");

    if(v === answers[r][c]){
      cell.classList.add("ok");
      ok++;
    }else{
      // ç©ºæ¬„ã¯è‰²ã‚’ä»˜ã‘ãªã„ï¼ˆå¥½ã¿ã§ bad ã«ã—ã¦ã‚‚OKï¼‰
      if(cell.querySelector("input").value.trim() !== ""){
        cell.classList.add("bad");
      }
    }
  }

  const score = Math.round((ok / (SIZE*SIZE)) * 100);
  document.getElementById("score").textContent = `ç‚¹æ•°ï¼š${score} / 100`;

  maybeStopTimerIfAllCorrect();
}

/* ===== å•é¡Œä½œæˆ ===== */
function make(){
  topNums = makeHeaderNums();
  leftNums = makeHeaderNums();
  buildAnswers();
  render();

  timerReset();
  timerStart();
}

/* ===== ã‚¤ãƒ™ãƒ³ãƒˆ ===== */
document.getElementById("makeBtn").addEventListener("click", make);
document.getElementById("checkBtn").addEventListener("click", check);

/* ===== åˆæœŸåŒ– ===== */
showBest();
setTimingUI();
</script>
</body>
</html>
