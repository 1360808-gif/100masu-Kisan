<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ä¹ä¹ã®81ã¾ã™è¨ˆç®—ï¼ˆ9Ã—9ï¼‰</title>

<style>
:root{
  --bg:#f7f8ff;
  --ink:#1f2937;
  --line:#e5e7eb;
  --accent:#4f46e5;
  --shadow:0 10px 24px rgba(0,0,0,.08);
  --mark: rgba(239,68,68,0.78);
  --header-bg: #eef2ff; /* å•é¡Œéƒ¨åˆ†ã®èƒŒæ™¯ */

  --cellW:56px;
  --cellH:46px;

  /* æ­£å††ã‚µã‚¤ã‚º */
  --circleOuter:30px;
  --circleInner:18px;
  --circleSingle:26px;
}
*{ box-sizing:border-box; }

body{
  margin:0;
  font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif;
  background:var(--bg);
  color:var(--ink);
  user-select: none;
  -webkit-user-select: none;
}
.wrap{ max-width:1200px; margin:16px auto; padding:0 12px 40px; }

.layout{
  display:grid;
  grid-template-columns: 1fr 380px;
  gap:12px;
  align-items:start;
}
@media(max-width:980px){
  .layout{ grid-template-columns:1fr; }
}

.panel{
  background:#fff;
  border:1px solid var(--line);
  border-radius:18px;
  padding:14px;
  box-shadow:0 6px 12px rgba(0,0,0,.06);
}
.card{
  background:#fff;
  border:1px solid var(--line);
  border-radius:24px;
  padding:14px;
  box-shadow:var(--shadow);
}

/* ===== å·¦ä¸Šï¼šã“ãŸãˆã‚’è¦‹ã‚‹ãƒœã‚¿ãƒ³è¡Œ ===== */
.leftTopRow{
  display:flex;
  align-items:center;
  justify-content:flex-start;
  gap:10px;
  margin-bottom:10px;
}
.leftTopRow .leftHint{
  font-weight:900;
  color:#6b7280;
  font-size:13px;
}

.peekBtn{
  width:auto;
  padding:8px 10px;
  border-radius:12px;
  border:2px solid rgba(79,70,229,.55);
  box-shadow: 0 0 0 2px rgba(79,70,229,.10);
  background:#fff;
  font-weight:1000;
  cursor:pointer;
  line-height:1;
  -webkit-touch-callout: none;
  touch-action: manipulation;
}
.peekBtn:hover{
  border-color: rgba(79,70,229,.75);
  box-shadow: 0 0 0 3px rgba(79,70,229,.12);
}
.peekBtn:active{ transform: translateY(1px); }
.peekBtn span{ display:inline-block; font-size:13px; pointer-events: none; }

/* ===== å³ã‚«ãƒ©ãƒ  ===== */
.rightStack{
  display:flex;
  flex-direction:column;
  gap:10px;
}
.row{ display:flex; align-items:center; width:100%; }
.rowTitle{ align-items:flex-start; }
.titleText{ margin:0; font-size:20px; font-weight:1000; line-height:1.25; }

/* ãƒ™ã‚¹ãƒˆè¡¨ç¤º */
.bestGroup{ display:flex; flex-direction:column; gap:8px; width:100%; }
.bestBox{
  display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:14px;
  border:1px dashed rgba(79,70,229,.55); background:#fbfbff; font-weight:1000; width:100%;
}
.bestLeft{ display:flex; align-items:baseline; gap:8px; white-space:nowrap; min-width:0; }
.bestLabel{ font-size:13px; opacity:.85; }
.bestValue{ font-size:20px; letter-spacing:.4px; }

.bestClearBtn{
  width:28px; height:28px; padding:0; border-radius:8px; border:1px solid var(--line);
  background:#fff; font-size:14px; font-weight:900; cursor:pointer; display:grid; place-items:center; flex:0 0 auto;
}
.bestClearBtn:hover{ background:#fee2e2; }

/* ãƒœã‚¿ãƒ³ */
button{
  padding:10px 12px; border-radius:12px; border:1px solid var(--line);
  background:#fff; font-weight:900; cursor:pointer; width:100%;
}
button.primary{ background:var(--accent); border-color:transparent; color:#fff; }
button.primary:focus{ outline: 3px solid rgba(79,70,229,.4); }

.makeBtns{ display:flex; gap:8px; width:100%; }
.makeBtns button{
  flex:1; padding:8px 6px; font-size:14px; white-space:nowrap;
  border:2px solid rgba(79,70,229,.55); box-shadow: 0 0 0 2px rgba(79,70,229,.10);
}

/* ã‚¿ã‚¤ãƒ è¡¨ç¤º */
.timer{
  display:flex; align-items:baseline; justify-content:space-between; gap:10px; padding:10px 12px;
  border-radius:14px; border:1px solid var(--line); background:#f8fafc; font-weight:1000; width:100%;
}
.timer .left{ display:flex; align-items:baseline; gap:8px; }
.timer .value{ font-size:22px; letter-spacing:.2px; }
.timer.running{ border-color: rgba(79,70,229,.45); box-shadow: 0 0 0 3px rgba(79,70,229,.12); }
.timerOff{ display:none; }

.switch{
  display:flex; align-items:center; justify-content:flex-start; gap:8px; padding:10px 12px;
  border-radius:12px; border:1px solid var(--line); background:#fff; font-weight:900; cursor:pointer; width:100%;
}

.note{ color:#6b7280; font-weight:900; font-size:13px; line-height:1.55; }
.errBar{ padding:10px 12px; border-radius:12px; border:1px solid #fecaca; background:#fff1f2; color:#991b1b; font-weight:900; display:none; }

/* ===== å·¦ï¼š81ã¾ã™ï¼ˆâ˜…ã“ã“ã‚’å¤§ããå¤‰æ›´ï¼‰ ===== */
.masuWrap{
  overflow:auto;
  border:1px solid var(--line);
  border-radius:16px;
  background:#fff;
}

table{
  border-collapse:separate;
  border-spacing:0;
  width:max-content;
  min-width:100%;
}
th, td{
  border-right:1px solid var(--line);
  border-bottom:1px solid var(--line);
  padding:0;
  width:var(--cellW);
  height:var(--cellH);
}
tr:first-child th{ border-top:1px solid var(--line); }
th:first-child, td:first-child{ border-left:1px solid var(--line); }

/* å•é¡Œã®æ•°å­— (ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†) â˜…ç›®ç«‹ãŸã›ã‚‹ */
th{
  background:var(--header-bg);
  color: #111827;
  font-weight: 1000; /* æ¥µå¤ª */
  font-size: 20px;   /* å¤§ãã */
  text-align:center;
  position:sticky;
  z-index:2;
}
th.top{ top:0; }
th.left{ left:0; z-index:3; }
th.corner{
  top:0; left:0; z-index:4;
  background:#dbeafe; /* è§’ã ã‘å°‘ã—è‰²ã‚’å¤‰ãˆã‚‹ */
  font-size: 18px;
  color: var(--accent);
}

/* å…¥åŠ›ã•ã‚Œã‚‹æ•°å­— â˜…å°è±¡ã‚’è–„ãã™ã‚‹ */
.cell{
  position:relative; width:100%; height:100%;
  display:flex; align-items:center; justify-content:center;
}
.cell input{
  width:100%; height:100%; border:0; outline:none; text-align:center;
  font-size:18px;
  font-weight: 500; /* â˜…å¤ªã•ã‚’æ¨™æº–ã«ï¼ˆä»¥å‰ã¯1000ï¼‰ */
  color: #4b5563;  /* â˜…å°‘ã—ã‚°ãƒ¬ãƒ¼ã«ã™ã‚‹ */
  background:transparent; padding:0; line-height:var(--cellH); display:block;
  user-select: text; -webkit-user-select: text;
}

/* åˆ¤å®šæ™‚ã®è‰² */
.cell.bad{ background:#fff7ed; }
.cell.bad input{ color:#9a3412; font-weight: 800; }
.cell.firstOk{ background:#ecfdf5; }
.cell.firstOk input{ color:#065f46; font-weight: 800; }
.cell.lateOk{ background:#eef2ff; }
.cell.lateOk input{ color:#1e3a8a; font-weight: 800; }
.cell.revealing{ background:#f8fafc; }
.cell.revealing input{ color:#111827; font-weight: 800; }

/* è¨˜å· (â—, ã€‡) */
.cell.firstOk::before, .cell.firstOk::after, .cell.lateOk::after {
  content:""; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); border-radius:50%; pointer-events:none;
}
.cell.firstOk::before{ width:var(--circleOuter); height:var(--circleOuter); border:3px solid var(--mark); }
.cell.firstOk::after{ width:var(--circleInner); height:var(--circleInner); border:3px solid var(--mark); }
.cell.lateOk::after{ width:var(--circleSingle); height:var(--circleSingle); border:3px solid var(--mark); }

.hankakuWarn{
  position:absolute; top:-26px; left:50%; transform:translateX(-50%);
  background:#fee2e2; color:#b91c1c; font-size:12px; font-weight:900; padding:4px 8px;
  border-radius:8px; white-space:nowrap; box-shadow:0 4px 8px rgba(0,0,0,.12);
  display:none; z-index:20;
}
.cell.warn .hankakuWarn{ display:block; }
.score{ margin-top:12px; font-weight:1000; font-size:18px; }
</style>
</head>

<body>
<div class="wrap">
  <div class="layout">
    <div class="panel">
      <div class="leftTopRow">
        <button id="peekBtn" class="peekBtn" type="button"><span>ã“ãŸãˆã‚’è¦‹ã‚‹</span></button>
        <div class="leftHint">â€» 0.3ç§’ é•·æŠ¼ã—</div>
      </div>
      <div class="masuWrap" id="masuWrap">
        <div style="padding:12px;font-weight:900;color:#6b7280;">å³ã®ãƒœã‚¿ãƒ³ã§ 81ã¾ã™ ã‚’ä½œã£ã¦ãã ã•ã„ã€‚</div>
      </div>
      <div class="score" id="score">ç‚¹æ•°ï¼šâ€” / 100</div>
    </div>

    <div class="card">
      <div class="rightStack">
        <h1 class="titleText">ä¹ä¹ã®81ã¾ã™è¨ˆç®—</h1>
        <div class="bestGroup" aria-live="polite">
          <div class="bestBox"><button class="bestClearBtn" id="clearBestUpBtn">ğŸ—‘</button>
            <div class="bestLeft"><span class="bestLabel">ğŸ† ä¸ŠãŒã‚Š</span><span class="bestValue" id="bestUpText">â€”</span><span class="bestLabel">ã³ã‚‡ã†</span></div>
          </div>
          <div class="bestBox"><button class="bestClearBtn" id="clearBestDownBtn">ğŸ—‘</button>
            <div class="bestLeft"><span class="bestLabel">ğŸ† ä¸‹ãŒã‚Š</span><span class="bestValue" id="bestDownText">â€”</span><span class="bestLabel">ã³ã‚‡ã†</span></div>
          </div>
          <div class="bestBox"><button class="bestClearBtn" id="clearBestRandBtn">ğŸ—‘</button>
            <div class="bestLeft"><span class="bestLabel">ğŸ† ãƒãƒ©ãƒãƒ©</span><span class="bestValue" id="bestRandText">â€”</span><span class="bestLabel">ã³ã‚‡ã†</span></div>
          </div>
        </div>
        <button class="primary" id="checkBtn">ã“ãŸãˆã‚ã‚ã›</button>
        <div class="row" id="timerInline">
          <div class="timer" id="timerBox"><div class="left">â± <span class="value" id="timerText">0.0</span> ã³ã‚‡ã†</div><div class="hint" id="timerHint"></div></div>
        </div>
        <label class="switch"><input type="checkbox" id="timingToggle" checked>ã‚¿ã‚¤ãƒ ã‚’ã¯ã‹ã‚‹</label>
        <div class="makeBtns">
          <button id="makeUpBtn">ä¸ŠãŒã‚Š</button>
          <button id="makeDownBtn">ä¸‹ãŒã‚Š</button>
          <button id="makeRandBtn">ãƒãƒ©ãƒãƒ©</button>
        </div>
        <div class="note">ãƒ»0.3ç§’é•·æŠ¼ã—ã§ãã®ãƒã‚¹ã®ç­”ãˆã‚’è¡¨ç¤º<br>ãƒ»å…¨å•æ­£è§£ã§è‡ªå‹•ã‚¹ãƒˆãƒƒãƒ—</div>
      </div>
    </div>
  </div>
</div>

<script>
/* åŸºæœ¬é–¢æ•° */
function toHalfWidth(str){ return String(str).replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)); }
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
function fmtTime(sec){ if(!Number.isFinite(sec)) return "â€”"; return sec < 60 ? sec.toFixed(1) : `${Math.floor(sec/60)}åˆ† ${ (sec%60).toFixed(1).padStart(4,"0") }`; }

const SIZE = 9;
const ASC = [1,2,3,4,5,6,7,8,9];
const DESC = [9,8,7,6,5,4,3,2,1];
let timingEnabled = true, currentMode = "up", lastFocusedInput = null;
let topNums = [], leftNums = [], answers = [], wrongChecks = [], solved = [], usedPeek = [];
let tStart = null, tStop = null, tTick = null;

const timerBox = document.getElementById("timerBox"), timerText = document.getElementById("timerText"), timerHint = document.getElementById("timerHint");

function timerReset(){ tStart = tStop = null; timerText.textContent = "0.0"; timerBox.classList.remove("running"); if(tTick){ clearInterval(tTick); tTick = null; } }
function timerStart(){
  if(!timingEnabled) return; tStart = performance.now(); tStop = null; timerBox.classList.add("running");
  if(tTick) clearInterval(tTick);
  tTick = setInterval(()=>{ const sec = (performance.now()-tStart)/1000; timerText.textContent = fmtTime(sec); }, 100);
}
function timerStop(){
  if(!timingEnabled || tStart==null || tStop!=null) return;
  tStop = performance.now(); const sec = (tStop - tStart)/1000; timerText.textContent = fmtTime(sec);
  timerBox.classList.remove("running"); if(tTick){ clearInterval(tTick); tTick = null; }
  tryUpdateBest(currentMode, sec);
}

/* ãƒ™ã‚¹ãƒˆè¨˜éŒ² */
const BEST_KEYS = { up: "best_up_v2", down: "best_down_v2", rand: "best_rand_v2" };
function loadBest(mode){ const v = localStorage.getItem(BEST_KEYS[mode]); return v ? Number(v) : null; }
function showAllBests(){
  document.getElementById("bestUpText").textContent = fmtTime(loadBest("up"));
  document.getElementById("bestDownText").textContent = fmtTime(loadBest("down"));
  document.getElementById("bestRandText").textContent = fmtTime(loadBest("rand"));
}
function tryUpdateBest(mode, sec){
  const best = loadBest(mode); if(best==null || sec < best){ localStorage.setItem(BEST_KEYS[mode], String(sec)); showAllBests(); }
}

/* ä½œæˆãƒ»æç”» */
function make(mode){
  currentMode = mode;
  topNums = (mode==="up") ? [...ASC] : (mode==="down") ? [...DESC] : shuffle([...ASC]);
  leftNums = (mode==="up") ? [...ASC] : (mode==="down") ? [...DESC] : shuffle([...ASC]);
  answers = Array.from({length:SIZE}, (_,r)=> Array.from({length:SIZE}, (_,c)=> leftNums[r]*topNums[c]));
  wrongChecks = Array(SIZE*SIZE).fill(0); solved = Array(SIZE*SIZE).fill(false); usedPeek = Array(SIZE*SIZE).fill(false);
  render(); timerReset(); timerStart();
}

function render(){
  const wrap = document.getElementById("masuWrap"); wrap.innerHTML = "";
  const table = document.createElement("table");
  const tr0 = document.createElement("tr");
  const corner = document.createElement("th"); corner.className="corner top left"; corner.textContent="Ã—";
  tr0.appendChild(corner);
  topNums.forEach(n => { const th=document.createElement("th"); th.className="top"; th.textContent=n; tr0.appendChild(th); });
  table.appendChild(tr0);

  for(let r=0; r<SIZE; r++){
    const tr = document.createElement("tr");
    const thL = document.createElement("th"); thL.className="left"; thL.textContent=leftNums[r];
    tr.appendChild(thL);
    for(let c=0; c<SIZE; c++){
      const td = document.createElement("td");
      const cell = document.createElement("div"); cell.className="cell"; cell.dataset.r=r; cell.dataset.c=c;
      cell.innerHTML = `<span class="hankakuWarn">åŠè§’æ•°å­—</span><input class="masuInput" inputmode="numeric">`;
      const inp = cell.querySelector("input");
      inp.addEventListener("focus", () => lastFocusedInput = inp);
      inp.addEventListener("input", (e) => {
        const val = toHalfWidth(e.target.value);
        if(e.target.value !== val){ cell.classList.add("warn"); setTimeout(()=> cell.classList.remove("warn"), 1500); }
        e.target.value = val;
        if(val.length >= String(answers[r][c]).length) focusByIndex(getInputs().indexOf(inp) + 1);
        if(allCorrect()) timerStop();
      });
      inp.addEventListener("keydown", handleKeyNav);
      td.appendChild(cell); tr.appendChild(td);
    }
    table.appendChild(tr);
  }
  wrap.appendChild(table);
  setTimeout(()=> focusByRC(0,0), 0);
}

/* ãƒŠãƒ“ãƒ»åˆ¤å®š */
function getInputs(){ return Array.from(document.querySelectorAll(".masuInput")); }
function focusByRC(r, c){
  const rr = (r+SIZE)%SIZE, cc = (c+SIZE)%SIZE;
  const inp = document.querySelector(`.cell[data-r="${rr}"][data-c="${cc}"] input`);
  if(inp){ inp.focus(); inp.select?.(); }
}
function focusByIndex(index){
  const inputs = getInputs(); if(index >= inputs.length) { document.getElementById("checkBtn").focus(); return; }
  const i = (index+inputs.length)%inputs.length; inputs[i].focus(); inputs[i].select?.();
}
function handleKeyNav(e){
  if(e.key === "Enter"){ e.preventDefault(); focusByIndex(getInputs().indexOf(e.target) + (e.shiftKey ? -1 : 1)); }
  if(!e.key.startsWith("Arrow")) return;
  e.preventDefault(); const cell = e.target.closest(".cell"); let r=+cell.dataset.r, c=+cell.dataset.c;
  if(e.key==="ArrowLeft") c--; if(e.key==="ArrowRight") c++; if(e.key==="ArrowUp") r--; if(e.key==="ArrowDown") r++;
  focusByRC(r,c);
}

function allCorrect(){ return getInputs().every(inp => { const cell=inp.closest(".cell"); return +inp.value === answers[+cell.dataset.r][+cell.dataset.c]; }); }
function check(){
  const cells = document.querySelectorAll(".cell"); let okCount = 0;
  cells.forEach(cell => {
    const r=+cell.dataset.r, c=+cell.dataset.c, idx=r*SIZE+c, inp=cell.querySelector("input"), val=inp.value.trim();
    if(val==="") return;
    if(+val === answers[r][c]){
      if(!solved[idx]){ solved[idx]=true; cell.classList.add((wrongChecks[idx]===0 && !usedPeek[idx]) ? "firstOk" : "lateOk"); }
      okCount++;
    } else { wrongChecks[idx]++; cell.classList.add("bad"); }
  });
  document.getElementById("score").textContent = `ç‚¹æ•°ï¼š${Math.round(okCount/81*100)} / 100`;
}

/* ã“ãŸãˆã‚’è¦‹ã‚‹ */
let peekTimer = null, peekTarget = null;
function startPeek(e){
  e.preventDefault(); if(!lastFocusedInput) return;
  peekTimer = setTimeout(()=>{
    const cell = lastFocusedInput.closest(".cell"); const r=+cell.dataset.r, c=+cell.dataset.c;
    peekTarget = { inp: lastFocusedInput, val: lastFocusedInput.value, cell: cell };
    lastFocusedInput.value = answers[r][c]; lastFocusedInput.readOnly = true;
    cell.classList.add("revealing"); usedPeek[r*SIZE+c] = true;
  }, 300);
}
function stopPeek(){ clearTimeout(peekTimer); if(peekTarget){ peekTarget.inp.value=peekTarget.val; peekTarget.inp.readOnly=false; peekTarget.cell.classList.remove("revealing"); peekTarget=null; } }

const pb = document.getElementById("peekBtn");
pb.addEventListener("mousedown", startPeek); pb.addEventListener("touchstart", startPeek, {passive:false});
window.addEventListener("mouseup", stopPeek); window.addEventListener("touchend", stopPeek);
pb.addEventListener("contextmenu", e => e.preventDefault());

document.getElementById("makeUpBtn").addEventListener("click", ()=>make("up"));
document.getElementById("makeDownBtn").addEventListener("click", ()=>make("down"));
document.getElementById("makeRandBtn").addEventListener("click", ()=>make("rand"));
document.getElementById("checkBtn").addEventListener("click", check);
document.getElementById("timingToggle").addEventListener("change", (e)=>{ timingEnabled=e.target.checked; document.getElementById("timerInline").classList.toggle("timerOff", !timingEnabled); timerReset(); });
document.getElementById("clearBestUpBtn").addEventListener("click", ()=> { localStorage.removeItem(BEST_KEYS.up); showAllBests(); });
document.getElementById("clearBestDownBtn").addEventListener("click", ()=> { localStorage.removeItem(BEST_KEYS.down); showAllBests(); });
document.getElementById("clearBestRandBtn").addEventListener("click", ()=> { localStorage.removeItem(BEST_KEYS.rand); showAllBests(); });

showAllBests();
</script>
</body>
</html>
